name: Security

permissions:
  contents: read
  security-events: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans weekly on Sundays at 00:00 UTC
    - cron: "0 0 * * 0"

jobs:
  # Python dependency vulnerability scanning
  safety-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install Poetry and export plugin
        run: |
          python -m pip install --upgrade pip
          pip install poetry poetry-plugin-export

      - name: Install dependencies
        run: poetry install --only dev

      - name: Export dependencies to requirements.txt
        run: poetry export --without-hashes -f requirements.txt -o requirements.txt --all-extras
        continue-on-error: true

      - name: Fallback - generate requirements from pyproject.toml
        if: ${{ !hashFiles('requirements.txt') }}
        run: |
          pip install toml
          python -c "
          import toml
          with open('pyproject.toml') as f:
              data = toml.load(f)
          deps = data.get('tool', {}).get('poetry', {}).get('dependencies', {})
          with open('requirements.txt', 'w') as f:
              for pkg, ver in deps.items():
                  if pkg != 'python':
                      if isinstance(ver, str):
                          f.write(f'{pkg}{ver.replace(\"^\", \">=\")}\\n')
                      elif isinstance(ver, dict):
                          f.write(f'{pkg}\\n')
          "

      - name: Run safety check
        run: |
          pip install safety
          safety check -r requirements.txt --output json > safety-report.json || true
          cat safety-report.json
        continue-on-error: true

      - name: Upload safety report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: safety-report
          path: safety-report.json
          retention-days: 30

  # CodeQL analysis for Python
  codeql:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install project runtime dependencies (so autobuild can detect the project)
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          # install runtime dependencies so CodeQL autobuild can detect any build/runtime steps
          poetry install --only main || true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        # No unsupported parameters passed to analyze; init@v4 already set languages/queries
